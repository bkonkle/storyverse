# AWS Notes

## Bootstrapping

To build a new account from scratch, first create an `<account-name>-root` IAM user to create the initial S3 bucket and DynamoDB table for Terraform state. Replace `<account-name>` with a name for this account - such as "dev".

Pick the "AdministratorAccess" from the "Set permissions" interface, and save the access key details to `~/.aws/credentials` like this:

```ini
[dev-root]
aws_access_key_id = <key id>
aws_secret_access_key = <access key>
```

These are the "keys to the kingdom" for this account, and should be guarded as such.

Then, navigate to the `config/accounts/bootstrap/<account-name>` directory and run:

```sh
AWS_PROFILE=dev-root terraform init
AWS_PROFILE=dev-root terraform apply
```

Use the same name for the `account_name` variable that you used for `<account-name>` above.

This only needs to be done once per account. Once the bucket and table are in place, there's no longer a need to bootstrap.

## Account Setup

Now, it's time to initialize the resources shared across all environments within this account. Navigate to the `config/environments/bootstrap` directory and run:

```sh
AWS_PROFILE=dev-root terraform init
AWS_PROFILE=dev-root terraform apply
```

This will create a new `storyverse-root` IAM user for this account, and give it the necessary permissions for storyverse resources. You should see a `root_access_key` `id` and `secret` in the outputs. Save them to `~/.aws/credentials` like this:

```ini
[storyverse-root]
aws_access_key_id = <id>
aws_secret_access_key = <secret>

```

## Environment Setup

Now it's time to switch to the `storyverse-root` user. To set up a new environment, navigate to the `config/environments/<env>` directory (replacing `<env>` with the tag for the new environment you want to set up, such as "dev").

```sh
AWS_PROFILE=storyverse-root terraform init
AWS_PROFILE=storyverse-root terraform apply
```

This will use the storyverse-root user to create resources for the environment.

## Local Development

To grant access to local development resources to a new team member, first create an IAM user with "AWS Management Console access" so that they can log in to view resources that they can access in the AWS UI. Use an autogenerated password, and make sure that they need to change it on the first login.

Add the user to the "storyverse-developer" group that should have been created by the environment setup step. Save the password for use with the login url: `https://<account-id>.signin.aws.amazon.com/console`

https://534904279422.signin.aws.amazon.com/console
